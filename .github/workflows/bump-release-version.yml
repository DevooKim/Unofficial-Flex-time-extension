name: Bump Version on Release Branch

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        default: stable
        options:
          - stable
          - beta
      release_branch:
        description: 'Release branch name (e.g. release/3.4.0)'
        required: true
        type: string
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
      prerelease_identifier:
        description: 'Prerelease identifier (used only for pre* types, e.g. beta)'
        required: false
        default: beta
        type: string

permissions:
  contents: write

jobs:
  bump_version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_branch }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          TYPE="${{ github.event.inputs.version_type }}"
          PRERELEASE_IDENTIFIER="${{ github.event.inputs.prerelease_identifier }}"
          RELEASE_BRANCH="${{ github.event.inputs.release_branch }}"

          if [ "$RELEASE_TYPE" = "stable" ] && [ "${RELEASE_BRANCH#release/}" = "$RELEASE_BRANCH" ]; then
            echo "Stable releases must use a branch prefixed with 'release/'."
            exit 1
          fi

          if [ "$RELEASE_TYPE" = "beta" ] && [ "${RELEASE_BRANCH#beta/}" = "$RELEASE_BRANCH" ]; then
            echo "Beta releases must use a branch prefixed with 'beta/'."
            exit 1
          fi

          if [ "$RELEASE_TYPE" = "stable" ] && [[ "$TYPE" == pre* ]]; then
            echo "Stable releases cannot use pre-release bump types."
            exit 1
          fi

          if [ "$RELEASE_TYPE" = "beta" ] && [[ "$TYPE" != pre* ]]; then
            echo "Beta releases must use one of pre* version types."
            exit 1
          fi

          if [ -z "$PRERELEASE_IDENTIFIER" ]; then
            PRERELEASE_IDENTIFIER=beta
          fi

          if [[ "$TYPE" == pre* ]]; then
            bunx standard-version --release-as "$TYPE" --prerelease "$PRERELEASE_IDENTIFIER" --skip.tag
          else
            bunx standard-version --release-as "$TYPE" --skip.tag
          fi

      - name: Sync manifest.json version
        run: |
          NEW_VERSION=$(bun -e "console.log(require('./package.json').version)")
          jq --arg version "$NEW_VERSION" '.version = $version' manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json
          if git diff --quiet HEAD -- manifest.json; then
            echo "manifest.json unchanged; skipping amend commit"
          else
            git add manifest.json
            HUSKY=0 git commit --amend --no-edit --no-verify
          fi

      - name: Push release branch
        run: git push origin "${{ github.event.inputs.release_branch }}"
